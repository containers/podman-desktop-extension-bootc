{
  "version": "2",
  "pipelines": [
    {
      "name": "build",
      "runner": "org.osbuild.linux",
      "stages": [
        {
          "type": "org.osbuild.container-deploy",
          "inputs": {
            "images": {
              "type": "org.osbuild.containers",
              "origin": "org.osbuild.source",
              "references": {
                "sha256:af00156a8a207b3dbc3f6c9ce692972dd36eaf73a22d1eaefff344740d545da6": {
                  "name": "quay.io/podai/test:latest"
                }
              }
            }
          },
          "options": {
            "exclude": [
              "/sysroot"
            ]
          }
        },
        {
          "type": "org.osbuild.selinux",
          "options": {
            "file_contexts": "etc/selinux/targeted/contexts/files/file_contexts",
            "labels": {
              "/usr/bin/mount": "system_u:object_r:install_exec_t:s0",
              "/usr/bin/ostree": "system_u:object_r:install_exec_t:s0",
              "/usr/bin/umount": "system_u:object_r:install_exec_t:s0"
            }
          }
        }
      ]
    },
    {
      "name": "ostree-deployment",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.ostree.init-fs"
        },
        {
          "type": "org.osbuild.ostree.os-init",
          "options": {
            "osname": "default"
          }
        },
        {
          "type": "org.osbuild.mkdir",
          "options": {
            "paths": [
              {
                "path": "/boot/efi",
                "mode": 448
              }
            ]
          }
        },
        {
          "type": "org.osbuild.ostree.deploy.container",
          "inputs": {
            "images": {
              "type": "org.osbuild.containers",
              "origin": "org.osbuild.source",
              "references": {
                "sha256:af00156a8a207b3dbc3f6c9ce692972dd36eaf73a22d1eaefff344740d545da6": {
                  "name": "quay.io/podai/test:latest"
                }
              }
            }
          },
          "options": {
            "osname": "default",
            "kernel_opts": [
              "rw",
              "console=tty0",
              "console=ttyS0"
            ],
            "target_imgref": "ostree-unverified-registry:quay.io/podai/test:latest",
            "rootfs": {
              "label": "root"
            },
            "mounts": [
              "/boot",
              "/boot/efi"
            ]
          }
        },
        {
          "type": "org.osbuild.ostree.config",
          "options": {
            "repo": "/ostree/repo",
            "config": {
              "sysroot": {
                "readonly": true,
                "bootloader": "none"
              }
            }
          },
          "mounts": [
            {
              "name": "ostree-ostree/1/1/0",
              "type": "org.osbuild.ostree.deployment",
              "options": {
                "deployment": {
                  "osname": "default",
                  "ref": "ostree/1/1/0",
                  "serial": 0
                }
              }
            }
          ]
        },
        {
          "type": "org.osbuild.fstab",
          "options": {
            "filesystems": [
              {
                "uuid": "585b90ea-d7df-47ba-9b2d-8ddcdb0f24b8",
                "vfs_type": "ext4",
                "path": "/",
                "options": "defaults",
                "freq": 1,
                "passno": 1
              },
              {
                "uuid": "a0ab59cc-d1b1-47ba-9484-8d16b3830641",
                "vfs_type": "ext4",
                "path": "/boot",
                "options": "ro",
                "freq": 1,
                "passno": 2
              },
              {
                "uuid": "7B77-95E7",
                "vfs_type": "vfat",
                "path": "/boot/efi",
                "options": "umask=0077,shortname=winnt",
                "passno": 2
              }
            ]
          },
          "mounts": [
            {
              "name": "ostree-ostree/1/1/0",
              "type": "org.osbuild.ostree.deployment",
              "options": {
                "deployment": {
                  "osname": "default",
                  "ref": "ostree/1/1/0",
                  "serial": 0
                }
              }
            }
          ]
        },
        {
          "type": "org.osbuild.ostree.selinux",
          "options": {
            "deployment": {
              "osname": "default",
              "ref": "ostree/1/1/0"
            }
          }
        }
      ]
    },
    {
      "name": "image",
      "build": "name:build",
      "stages": [
        {
          "type": "org.osbuild.truncate",
          "options": {
            "filename": "disk.raw",
            "size": "10737418240"
          }
        },
        {
          "type": "org.osbuild.sfdisk",
          "options": {
            "label": "gpt",
            "uuid": "D209C89E-EA5E-4FBD-B161-B461CCE297E0",
            "partitions": [
              {
                "bootable": true,
                "size": 2048,
                "start": 2048,
                "type": "21686148-6449-6E6F-744E-656564454649",
                "uuid": "FAC7F1FB-3E8D-4137-A512-961DE09A5549"
              },
              {
                "size": 1026048,
                "start": 4096,
                "type": "C12A7328-F81F-11D2-BA4B-00A0C93EC93B",
                "uuid": "68B2905B-DF3E-4FB3-80FA-49D1E773AA33"
              },
              {
                "size": 2097152,
                "start": 1030144,
                "type": "0FC63DAF-8483-4772-8E79-3D69D8477DE4",
                "uuid": "CB07C243-BC44-4717-853E-28852021225B"
              },
              {
                "size": 17844191,
                "start": 3127296,
                "type": "0FC63DAF-8483-4772-8E79-3D69D8477DE4",
                "uuid": "6264D520-3FB9-423F-8AB8-7A0A8E3D3562"
              }
            ]
          },
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.raw",
                "lock": true
              }
            }
          }
        },
        {
          "type": "org.osbuild.mkfs.fat",
          "options": {
            "volid": "7B7795E7"
          },
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.raw",
                "start": 4096,
                "size": 1026048,
                "lock": true
              }
            }
          }
        },
        {
          "type": "org.osbuild.mkfs.ext4",
          "options": {
            "uuid": "a0ab59cc-d1b1-47ba-9484-8d16b3830641",
            "label": "boot"
          },
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.raw",
                "start": 1030144,
                "size": 2097152,
                "lock": true
              }
            }
          }
        },
        {
          "type": "org.osbuild.mkfs.ext4",
          "options": {
            "uuid": "585b90ea-d7df-47ba-9b2d-8ddcdb0f24b8",
            "label": "root"
          },
          "devices": {
            "device": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.raw",
                "start": 3127296,
                "size": 17844191,
                "lock": true
              }
            }
          }
        },
        {
          "type": "org.osbuild.copy",
          "inputs": {
            "root-tree": {
              "type": "org.osbuild.tree",
              "origin": "org.osbuild.pipeline",
              "references": [
                "name:ostree-deployment"
              ]
            }
          },
          "options": {
            "paths": [
              {
                "from": "input://root-tree/",
                "to": "mount://-/"
              }
            ]
          },
          "devices": {
            "-": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.raw",
                "start": 3127296,
                "size": 17844191
              }
            },
            "boot": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.raw",
                "start": 1030144,
                "size": 2097152
              }
            },
            "boot-efi": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.raw",
                "start": 4096,
                "size": 1026048
              }
            }
          },
          "mounts": [
            {
              "name": "-",
              "type": "org.osbuild.ext4",
              "source": "-",
              "target": "/"
            },
            {
              "name": "boot",
              "type": "org.osbuild.ext4",
              "source": "boot",
              "target": "/boot"
            },
            {
              "name": "boot-efi",
              "type": "org.osbuild.fat",
              "source": "boot-efi",
              "target": "/boot/efi"
            }
          ]
        },
        {
          "type": "org.osbuild.bootupd",
          "options": {
            "deployment": {
              "osname": "default",
              "ref": "ostree/1/1/0"
            },
            "static-configs": true,
            "bios": {
              "device": "disk"
            }
          },
          "devices": {
            "-": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.raw",
                "start": 3127296,
                "size": 17844191
              }
            },
            "boot": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.raw",
                "start": 1030144,
                "size": 2097152
              }
            },
            "boot-efi": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.raw",
                "start": 4096,
                "size": 1026048
              }
            },
            "disk": {
              "type": "org.osbuild.loopback",
              "options": {
                "filename": "disk.raw"
              }
            }
          },
          "mounts": [
            {
              "name": "-",
              "type": "org.osbuild.ext4",
              "source": "-",
              "target": "/"
            },
            {
              "name": "boot",
              "type": "org.osbuild.ext4",
              "source": "boot",
              "target": "/boot"
            },
            {
              "name": "boot-efi",
              "type": "org.osbuild.fat",
              "source": "boot-efi",
              "target": "/boot/efi"
            }
          ]
        }
      ]
    }
  ],
  "sources": {
    "org.osbuild.skopeo": {
      "items": {
        "sha256:af00156a8a207b3dbc3f6c9ce692972dd36eaf73a22d1eaefff344740d545da6": {
          "image": {
            "name": "quay.io/podai/test",
            "digest": "sha256:2e74e56e4598257dc9131b1de4320394294fd07bea549930a2cb8d0c7b1a26c7",
            "tls-verify": true
          }
        }
      }
    }
  }
}
